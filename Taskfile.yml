version: '3'

tasks:
  default:
    - task: run

  run:
    deps: [build-hotreload]
    cmds:
      - task build-debug
      - ./build/debug/main.exe

  run-release:
    cmds:
      - task build-release
      - ./build/release/main.exe

  run-meta:
    deps: [build-meta]
    cmds:
      - ./build/meta.exe

  debug:
    cmds:
      - task build-debug
      - powershell ./scripts/debug-rad.ps1

  build-meta:
    sources:
      - meta/**/*.odin
    cmds:
      - odin build meta -out:build/meta.exe -debug

  build-shaders-tools:
    sources:
      - shaders/**/*.slang
    cmds:
      - pwsh ./scripts/build-shaders-tools.ps1

  build-shaders:
    sources:
      - shaders/**/*.slang
    cmds:
      - pwsh ./scripts/build-shaders.ps1

  build-debug:
    sources:
      - src/**/*.odin
      - main_hotreload/**/*.odin
    cmds:
      - pwsh ./scripts/build-debug.ps1

  build-release:
    deps: [build-shaders]
    cmds:
      - pwsh ./scripts/build-release.ps1

  build-hotreload:
    sources:
      - src/**/*.odin
    cmds:
      - pwsh ./scripts/build-hotreload.ps1

  check:
    cmds:
      - odin check . -strict-style -warnings-as-errors -vet

  build-dfg:
    sources:
      - src/**/*.odin
      - tools/**/*.odin
    deps: [build-shaders-tools]
    cmds:
      - odin build ./tools/dfg.odin -file --collection:deps=./deps --ignore-unknown-attributes -o:aggressive -linker:lld

  build-prefilter:
    sources:
      - src/**/*.odin
      - tools/**/*.odin
    deps: [build-shaders-tools]
    cmds:
      - odin build ./tools/prefilter.odin -file --collection:deps=./deps --ignore-unknown-attributes -o:aggressive -linker:lld

  build-sh:
    sources:
      - src/**/*.odin
      - tools/**/*.odin
    deps: [build-shaders-tools]
    cmds:
      - odin build ./tools/sh.odin -file --collection:deps=./deps --ignore-unknown-attributes -o:aggressive -linker:lld

  dfg:
    deps: [build-dfg]
    cmds:
      - ./dfg.exe assets/gen/dfg -size=256

  test-cubemap:
    deps: [build-prefilter]
    cmds:
      - ./prefilter.exe assets/textures/environment/test_cubemap.ktx2 assets/gen/test_cubemap_ld

  ennis-raw-cubemap:
    deps: [build-prefilter]
    cmds:
      - ./prefilter.exe assets/textures/environment/ennis_raw.ktx2 assets/gen/test_cubemap_ld -size=512

  ennis-cubemap:
    deps: [build-prefilter]
    cmds:
      - ./prefilter.exe assets/textures/environment/ennis.ktx2 assets/gen/test_cubemap_ld

  rosendal-cubemap:
    deps: [build-prefilter]
    cmds:
      - ./prefilter.exe assets/textures/environment/rosendal.ktx2 assets/gen/test_cubemap_ld

  white-furnace-cubemap:
    deps: [build-prefilter]
    cmds:
      - ./prefilter.exe assets/textures/environment/white_furnace.ktx2 assets/gen/test_cubemap_ld

  test:
    cmds:
      - odin test src -collection:deps=deps -debug -ignore-unknown-attributes

